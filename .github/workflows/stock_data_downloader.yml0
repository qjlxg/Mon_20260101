name: stock_data_downloader

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ª workflow è¿è¡Œï¼Œé¿å…å¤šä¸ªå®šæ—¶ä»»åŠ¡å¹¶å‘å¯¼è‡´å†²çª
concurrency:
  group: stock-data-update
  cancel-in-progress: true

on:
  push:
    paths:
      - 'stock_data_downloader.py'
      - '.github/workflows/stock_data_downloader.yml'
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 15:19 æ‰§è¡Œï¼ˆUTC æ—¶é—´ 7:19ï¼‰
    - cron: '09 7 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  download-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ‰èƒ½æ¨é€ commit

    steps:
      - name: Checkout Code with Retry
        uses: actions/checkout@v4
        with:
          fetch-depth: 1          # æµ…å…‹éš†ï¼ŒåŠ å¿« checkout é€Ÿåº¦å¹¶é™ä½å¤±è´¥ç‡
          persist-credentials: true
          # è‡ªåŠ¨é‡è¯• checkoutï¼ˆæœ€å¤š 3 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 20 ç§’ï¼‰
          retry: true
          retry-max-attempts: 3
          retry-wait-seconds: 20

      - name: Configure Git for stability
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # å¢å¤§ç¼“å†²åŒºï¼Œé˜²æ­¢å¤§æ–‡ä»¶æ¨é€å¤±è´¥
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install akshare pandas

      - name: Run Downloader with Auto-Retry
        run: |
          mkdir -p stock_data
          ATTEMPTS=0
          MAX_ATTEMPTS=20
          until [ $ATTEMPTS -ge $MAX_ATTEMPTS ]; do
            if python stock_data_downloader.py; then
              echo "ğŸ‰ æœ¬è½®ä¸‹è½½ä»»åŠ¡é¡ºåˆ©æ‰§è¡Œå®Œæ¯•ã€‚"
              break
            else
              ATTEMPTS=$((ATTEMPTS+1))
              echo "ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•ç¬¬ $ATTEMPTS æ¬¡ï¼ˆ10ç§’åï¼‰..."
              sleep 10
            fi
          done
          if [ $ATTEMPTS -ge $MAX_ATTEMPTS ]; then
            echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¸‹è½½å¤±è´¥"
            exit 1
          fi

      # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ --autostash è‡ªåŠ¨å¤„ç†æœ¬åœ°æ–°ç”Ÿæˆçš„æ–‡ä»¶
      - name: Sync latest changes before commit (é¿å…æ¨é€å†²çª)
        run: |
          git pull --rebase --autostash origin main

      - name: Git Auto Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat(stock): daily update [skip ci]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          file_pattern: stock_data/*.csv stock_data/*.txt
          skip_dirty_check: false   # é»˜è®¤ falseï¼Œç¡®ä¿æœ‰æ”¹åŠ¨æ‰ commit
          # [skip ci] ä¼šé˜»æ­¢å†æ¬¡è§¦å‘ workflowï¼Œé¿å…æ— é™å¾ªç¯
